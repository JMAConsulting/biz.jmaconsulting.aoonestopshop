From f777493023257d9096e5ae5e703a29e7c3369be5 Mon Sep 17 00:00:00 2001
From: Monish Deb <deb.monish@gmail.com>
Date: Thu, 12 Mar 2020 22:11:39 +0530
Subject: [PATCH] refactor camp fields

---
 .../Form/ProviderApplicationConfirm.php       | 29 ++++++++++---------
 .../Form/ProviderApplicationConfirm.tpl       | 26 +++++++++--------
 2 files changed, 30 insertions(+), 25 deletions(-)

diff --git a/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.php b/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.php
index 0a223a8..9404515 100644
--- a/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.php
+++ b/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.php
@@ -40,32 +40,35 @@ public function buildQuickForm() {
     $customFields = civicrm_api3('CustomField', 'get', ['custom_group_id' => CAMP_CG])['values'];
     $campValues = [];
     $count = 1;
+    $entryFound = 0;
     $totalCount = 21;
     while($count < $totalCount) {
       $entryFound = FALSE;
-      $campValues[$count] = [];
       foreach ($customFields as $customField) {
         $key = 'custom_' . $customField['id'];
-        $campValues[$count][$key] = [
-          'label' => $customField['label'],
-          'html' => NULL,
-        ];
-        if (!empty($defaults[$key . '_-' . $count])) {
-          $campValues[$count][$key]['html'] = $defaults[$key . '_-' . $count];
-          $entryFound = TRUE;
-        }
-        elseif (!empty($defaults[$key . '_' . $count])) {
-          $campValues[$count][$key]['html'] = $defaults[$key . '_' . $count];
+        if (!empty($defaults[$key . '_-' . $count]) || !empty($defaults[$key . '_' . $count])) {
           $entryFound = TRUE;
         }
       }
       if (!$entryFound) {
-        unset($campValues[$count]);
+        $entryFound++;
       }
       $count++;
     }
 
-    $this->assign('campValues', $campValues);
+    // this part is to render camp fields
+    $campFields = [];
+    for ($i = 1; $i <= $entryFound; $i++) {
+      $campFields[$i] = [];
+      foreach ($customFields as $customField) {
+        // when we insert new value for multi-valued custom field the key is suppose to be in custom_xx_-1 otherwise custom_xx_1 where xx is the custom field id
+        $marker = $this->organizationId ? $i : '-' . $i;
+        $key = 'custom_' . $customField['id'] . '_' . $marker;
+        $campFields[$i][] = $key;
+        CRM_Core_BAO_CustomField::addQuickFormElement($this, $key, $customField['id'], FALSE);
+      }
+    }
+    $this->assign('campFields', $campFields);
 
     $this->setDefaults($defaults);
     $this->freeze();
diff --git a/templates/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.tpl b/templates/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.tpl
index be465dc..01bc1b7 100644
--- a/templates/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.tpl
+++ b/templates/CRM/Aoservicelisting/Form/ProviderApplicationConfirm.tpl
@@ -94,19 +94,21 @@
   {include file="CRM/UF/Form/Block.tpl" fields=$profile2}
 </div>
 
-{if !empty($campValues)}
-  {section name='c' start=1 loop=21}
-    {assign var='rowN' value=$smarty.section.c.index}
-    {if !empty($campValues.$rowN)}
-      <div id="camp_session-{$rowN}" class="crm-section camp-section camp-section-{$rowN} {cycle values="odd-row,even-row"}">
-        {foreach from=$campValues.$rowN key=customKey item=dontCare}
-          <div class="label">{$campValues.$rowN.$customKey.label}</div>
-          <div class="content">{$campValues.$rowN.$customKey.html}</div>
-          <div class="clear"></div>
-        {/foreach}
+{if !empty($campFields)}
+{section name='c' start=1 loop=21}
+  {assign var='rowN' value=$smarty.section.c.index}
+  {if !empty($campFields.$rowN)}
+    <div id="camp_session-{$rowN}" class="camp-section camp-section-{$rowN} {if $rowN > 1}hiddenElement{/if} {cycle values="odd-row,even-row"}">
+      {foreach from=$campFields.$rowN item=field}
+      <div class="crm-section">
+        <div class="label">{$form.$field.label}</div>
+        <div class="content">{$form.$field.html}</div>
+        <div class="clear"></div>
       </div>
-    {/if}
-  {/section}
+      {/foreach}
+    </div>
+  {/if}
+{/section}
 {/if}
 
 {* FOOTER *}
